name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Environment
      - name: Show selected environment
        run: echo "Deploying to ${{ github.event.inputs.environment }}"

      # 3Ô∏è‚É£ Setup .NET 8 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 4Ô∏è‚É£ Restore (PROJECT only)
           # 4Ô∏è‚É£ Restore (PROJECT only)
      - name: Restore dependencies
        run: dotnet restore ServicePro.API/ServicePro.API.csproj

      # 5Ô∏è‚É£ Build
      - name: Build project
        run: dotnet build ServicePro.API/ServicePro.API.csproj -c Release --no-restore

      # 6Ô∏è‚É£ Publish (PROJECT only)
      - name: Publish project
        run: dotnet publish ServicePro.API/ServicePro.API.csproj -c Release -o publish

      # üî• 6.1Ô∏è‚É£ Force IIS Restart (web.config touch)
      - name: Trigger IIS Restart
        run: |
          echo "<!-- restart $(date) -->" >> publish/web.config

      # 7Ô∏è‚É£ Deploy FULL APP (NOT only wwwroot)
      - name: Deploy to MonsterASP.NET
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./publish/
          server-dir: /
          dangerous-clean-slate: false
          log-level: verbose
